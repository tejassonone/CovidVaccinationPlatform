{% extends "base.html" %}
{% block content %}




<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
    crossorigin="anonymous"></script>
  <title>Search</title>
</head>

<body>

  <div class="container card card-body">
    <form method="GET" class="mt-5" id="myForm">
      {% csrf_token %}

      <div id="alert-box"></div>
      <div class="row">
        <div class="col-md custom_select">
          <select name="state" id="state" class="form-control input-lg">
            <option value="">Select state</option>
          </select>
        </div>

        <div class="col-md custom_select">
          <select name="district" id="district" class="form-control input-lg">
            <option value="">Select district</option>
          </select>
        </div>

        <div class="col-md custom_select">
          <select name="block" id="block" class="form-control input-lg">
            <option value="">Select block</option>
          </select>
        </div>

        <div class="col-md custom_select">
          <select name="pincode" id="pincode" class="form-control input-lg">
            <option value="">Select pincode</option>
          </select>
        </div>
      </div>

      <div id="" class="mt-3">
        <button type="submit" class="btn btn-outline-info">Search</button>
      </div>
    </form>
  </div>





  <div class="container mt-3">


    <div class="row non-visible" id="my-centreTable">
      <div class="slider">
        <div class="link_section">
          <a class="btn custom_btn mb-1" href="#slide-1">week 1</a>
          <a class="btn custom_btn mb-1" href="#slide-2">week 2</a>
          <a class="btn custom_btn mb-1" href="#slide-3">week 3</a>
          <a class="btn custom_btn mb-1" href="#slide-4">week 4</a>
        </div>

        <div class="row">
          <div class="col-4">
            <table class="table table-bordered">
              <thead>
                <tr class="table-primary">
                  <th scope="col-8">Centre name</th>
                </tr>
              </thead>
              <tbody id="centre-data">

              </tbody>
            </table>
          </div>

          <div class="col-8">
            <div class="slides">
              <div id="slide-1">
                <table class="table table-bordered">
                  <thead>
                    <tr class="table-primary" id="week-1-date">
                    </tr>
                  </thead>
                  <tbody id="week-1-session">
                  </tbody>
                </table>
              </div>
              <div id="slide-2">
                <table class="table table-bordered">
                  <thead>
                    <tr class="table-primary" id="week-2-date">
                    </tr>
                  </thead>
                  <tbody id="week-2-session">
                  </tbody>
                </table>
              </div>
              <div id="slide-3">
                <table class="table table-bordered">
                  <thead>
                    <tr class="table-primary" id="week-3-date">
                    </tr>
                  </thead>
                  <tbody id="week-3-session">
                  </tbody>
                </table>
              </div>
              <div id="slide-4">
                <table class="table table-bordered">
                  <thead>
                    <tr class="table-primary" id="week-4-date">
                    </tr>
                  </thead>
                  <tbody id="week-4-session">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>







  </div>


</body>


<!-- Button trigger modal -->


<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modelbody">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <div id="appointment_btn">
          <button type="button" class="btn btn-primary" disabled>Book Appointment</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .mt-5 {
    margin-top: 5px !important;
  }

  .non-visible {
    display: none;
  }

  .table_content {

    margin-top: 30px;

  }

  .table_content thead tr {
    background-color: #27bec9;
    color: #fff;
    font-weight: bold;
  }


  .non_visible {
    display: none;
  }

  .custom_select {
    position: relative;
    height: 37px;
    width: 100%;
  }


  .custom_select:before {
    content: "";
    position: absolute;
    top: 15px;
    right: 20px;
    border: 8px solid;
    border-color: #d5dbd9 transparent transparent transparent;
    pointer-events: none;
  }
</style>
<style>
  .slider {
    width: 1800px;
    text-align: center;
    overflow: hidden;
  }

  .slider .link_section {
    text-align: end;
    margin: 0.5rem 3.5rem 0.5rem 0;
    text-decoration: none;
  }

  .slides {
    display: flex;

    overflow-x: auto;
    scroll-snap-type: x mandatory;



    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;

    /*
    scroll-snap-points-x: repeat(300px);
    scroll-snap-type: mandatory;
    */
  }

  .slides::-webkit-scrollbar {
    width: 10px;
    height: 10px;
    margin-left: 80px;
  }

  .slides::-webkit-scrollbar-thumb {
    background: black;
    border-radius: 10px;
  }

  .slides::-webkit-scrollbar-track {
    background: transparent;
  }

  .slides>div {
    scroll-snap-align: start;
    flex-shrink: 0;
    width: 800px;
    height: 500px;
    margin-right: 50px;
    border-radius: 10px;
    transform-origin: center center;
    transform: scale(1);
    transition: transform 0.5s;
    position: relative;

    display: flex;


  }

  .slides>div:target {
    /*   transform: scale(0.8); */
  }

  .author-info {
    background: rgba(0, 0, 0, 0.75);
    color: white;
    padding: 0.75rem;
    text-align: center;
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    margin: 0;
  }

  .author-info a {
    color: white;
  }

  img {
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .slider>a {
    display: inline-flex;
    width: 3.1rem;
    height: 3.1rem;
    background: white;
    text-decoration: none;
    align-items: flex-end;
    justify-content: flex-end;
    /*  border-radius: 100%; */
    margin: 0 0.5rem 0.5rem 0;
    position: relative;
  }

  .slider>a:active {
    top: 1px;
  }

  .slider>a:focus {
    background: #000;
  }

  /* Don't need button navigation */
  @supports (scroll-snap-type) {
    .slider>a {
      display: none;
    }
  }
</style>

<script type="text/javascript">



  const stateInput = document.getElementById('state')
  const districtInput = document.getElementById('district')
  const blockInput = document.getElementById('block')



  const csrf = document.getElementsByName('csrfmiddlewaretoken')
  console.log(csrf)

  const myForm = document.getElementById('myForm')
  const alertBox = document.getElementById('alert-box')
  const tableData = document.getElementById('table-data')


  const myTable = document.getElementById('my-table')







  $.ajax({
    type: 'GET',
    url: '/appointment/state-json/',
    success: function (response) {
      var statesData = response.data
      var html_code = '';
      html_code += '<option value="">Select state</option>';
      statesData.map(items => {
        html_code += '<option value="' + items.state_name + '">' + items.state_name + '</option>';
      })
      $('#state').html(html_code);
    },
    error: function (error) {
      console.log(error)
    }
  })

  stateInput.addEventListener('change', e => {
    console.log(e.target.value)
    const selectedState = e.target.value

    $('#district').html('<option value="">Select district</option>');
    $('#block').html('<option value="">Select block</option>');
    $('#pincode').html('<option value="">Select pincode</option>');


    $.ajax({
      type: 'GET',
      url: `/appointment/district-json/${selectedState}/`,
      success: function (response) {
        console.log(response)
        var districtData = response.data

        var html_code = '';
        html_code += '<option value="">Select district</option>';
        districtData.map(items => {
          html_code += '<option value="' + items.district_name + '">' + items.district_name + '</option>';
        })
        $('#district').html(html_code);
      },
      error: function (error) {
        console.log(error)
      }
    })
  })




  districtInput.addEventListener('change', e => {
    console.log('district', e.target.value)
    const selectedState = document.getElementById('state').value
    const selectedDistrict = e.target.value


    $('#block').html('<option value="">Select block</option>');
    $('#pincode').html('<option value="">Select pincode</option>');

    $.ajax({
      type: 'GET',
      url: `/appointment/block-json/${selectedState}/${selectedDistrict}/`,
      success: function (response) {
        console.log(response)
        var blockData = response.data
        var html_code = '';
        html_code += '<option value="">Select block</option>';
        blockData.map(items => {
          html_code += '<option value="' + items.block_name + '">' + items.block_name + '</option>';
        })
        $('#block').html(html_code);
      },
      error: function (error) {
        console.log(error)
      }
    })
  })




  blockInput.addEventListener('change', e => {
    console.log(e.target.value)
    const selectedState = document.getElementById('state').value
    const selectedDistrict = document.getElementById('district').value
    const selectedBlock = e.target.value


    $('#pincode').html('<option value="">Select pincode</option>');

    $.ajax({
      type: 'GET',
      url: `/appointment/block-json/${selectedState}/${selectedDistrict}/${selectedBlock}/`,
      success: function (response) {
        console.log(response)
        var pincodeData = response.data
        var html_code = '';
        html_code += '<option value="">Select pincode</option>';
        pincodeData.map(items => {
          html_code += '<option value="' + items.pincode + '">' + items.pincode + '</option>';
        })
        $('#pincode').html(html_code);
      },
      error: function (error) {
        console.log(error)
      }
    })
  })


  function ViewBtn(id) {
    window.location = '/appointment/book_appointment/' + id;
  }




  myForm.addEventListener('submit', e => {
    const centre_name_data = document.getElementById('centre-data')
    const week_1_session = document.getElementById('week-1-session')
    const week_2_session = document.getElementById('week-2-session')
    const week_3_session = document.getElementById('week-3-session')
    const week_4_session = document.getElementById('week-4-session')

    const week_1_date = document.getElementById('week-1-date')
    const week_2_date = document.getElementById('week-2-date')
    const week_3_date = document.getElementById('week-3-date')
    const week_4_date = document.getElementById('week-4-date')


    const mycentreTable = document.getElementById('my-centreTable')

    e.preventDefault()
    console.log("submitted")


    $.ajax({
      type: 'GET',
      url: '/appointment/search/',
      data: {
        'csrfmiddlewaretoken': csrf[0].value,
        'state_name': document.getElementById('state').value,
        'district_name': document.getElementById('district').value,
        'block_name': document.getElementById('block').value,
        'pincode': document.getElementById('pincode').value,
      },
      success: function (response) {
        console.log(response)
        mycentreTable.classList.remove('non-visible')
        var centreData = response.data
        centreData.map(items => {
          // var row = "<tr><td>"+items.centre_name+"</td><td>NA</td><td>NA</td><td><button class='btn btn-outline-info' id='view_btn' onclick=ViewBtn("+items.centre_id+")>view</button></td></tr>"

          var centreName = "<tr><td>" + items.centre_name + "</td></tr>"
          var week1date = ""
          var week2date = ""
          var week3date = ""
          var week4date = ""

          for (var i = 0; i < 7; i++) {
            row = "<th scope='col'>" + items.session[i].date + "</th>"
            week1date += row
          }
          week_1_date.innerHTML = week1date

          for (var i = 7; i < 14; i++) {
            row = "<th scope='col'>" + items.session[i].date + "</th>"
            week2date += row
          }
          week_2_date.innerHTML = week2date

          for (var i = 14; i < 21; i++) {
            row = "<th scope='col'>" + items.session[i].date + "</th>"
            week3date += row
          }
          week_3_date.innerHTML = week3date

          for (var i = 21; i < 28; i++) {
            row = "<th scope='col'>" + items.session[i].date + "</th>"
            week4date += row
          }
          week_4_date.innerHTML = week4date

          var week1session = ""
          var week2session = ""
          var week3session = ""
          var week4session = ""




          for (var i = 0; i < 7; i++) {
            if (items.session[i].v_count != 0 && items.session[i].action == 'Book') {
              row = "<td><button type='button' class='btn btn-primary' data-bs-toggle='modal' data-bs-target='#exampleModal' onclick=selectSession(" + items.session[i].session_id + ")>" + items.session[i].action + "</button></td>"
            } else if (items.session[i].v_count != 0 && items.session[i].action == 'Booked') {
              row = "<td><button type='button' class='btn btn-secondary'>" + items.session[i].action + "</button></td>"
            } else {
              row = "<td>NA</td>"
            }
            week1session += row
          }
          for (var i = 7; i < 14; i++) {
            if (items.session[i].v_count != 0 && items.session[i].action == 'Book') {
              row = "<td><button type='button' class='btn btn-primary' data-bs-toggle='modal' data-bs-target='#exampleModal' onclick=selectSession(" + items.session[i].session_id + ")>" + items.session[i].action + "</button></td>"
            } else if (items.session[i].v_count != 0 && items.session[i].action == 'Booked') {
              row = "<td><button type='button' class='btn btn-secondary'>" + items.session[i].action + "</button></td>"
            } else {
              row = "<td>NA</td>"
            }
            week2session += row
          }
          for (var i = 14; i < 21; i++) {
            if (items.session[i].v_count != 0 && items.session[i].action == 'Book') {
              row = "<td><button type='button' class='btn btn-primary' data-bs-toggle='modal' data-bs-target='#exampleModal' onclick=selectSession(" + items.session[i].session_id + ")>" + items.session[i].action + "</button></td>"
            } else if (items.session[i].v_count != 0 && items.session[i].action == 'Booked') {
              row = "<td><button type='button' class='btn btn-secondary'>" + items.session[i].action + "</button></td>"
            } else {
              row = "<td>NA</td>"
            }
            week3session += row
          }
          for (var i = 21; i < 28; i++) {
            if (items.session[i].v_count != 0 && items.session[i].action == 'Book') {
              row = "<td><button type='button' class='btn btn-primary' data-bs-toggle='modal' data-bs-target='#exampleModal' onclick=selectSession(" + items.session[i].session_id + ")>" + items.session[i].action + "</button></td>"
            } else if (items.session[i].v_count != 0 && items.session[i].action == 'Booked') {
              row = "<td><button type='button' class='btn btn-secondary'>" + items.session[i].action + "</button></td>"
            } else {
              row = "<td>NA</td>"
            }
            week4session += row
          }

          week_1_session.innerHTML += "<tr>" + week1session + "</tr>"
          week_2_session.innerHTML += "<tr>" + week2session + "</tr>"
          week_3_session.innerHTML += "<tr>" + week3session + "</tr>"
          week_4_session.innerHTML += "<tr>" + week4session + "</tr>"

          centre_name_data.innerHTML += centreName
        })



      },
      error: function (error) {
        console.log(error)
        alertBox.innerHTML = `<div class="alert alert-danger" role="alert">
                                        Something went wrong.. 
                                       </div>`
      }
    })
  })





  function selectSession(s_id) {
    console.log('session')

    const model_name = document.getElementById('exampleModalLabel')
    const model_body = document.getElementById('modelbody')
    const appointment_button = document.getElementById('appointment_btn')

    $.ajax({
      type: 'GET',
      url: `/appointment/centre-detail/${s_id}/`,
      success: function (response) {
        console.log(response.data)
        server_data = response.data



        server_data.map(items => {
          model_name.innerHTML = "<h5>" + items.centre_name + ", " + "</h5><h5>" + items.block + "</h5>"
          model_body.innerHTML = "<div class='row'><h5 class='col-6 col-md'>Session ID</h5><p class='col-6 col-md'>" + items.session_id
            + "</p></div><div class='row'><h5 class='col-6 col-md'>Slot</h5><p class='col-6 col-md'>" + items.session_date
            + "</p></div><div class='row'><h5 class='col-6 col-md'>Session date</h5><p class='col-6 col-md'>" + items.slot
            + "</p></div>"

          appointment_button.innerHTML = "<button type='button' class='btn btn-primary' data-bs-dismiss='modal' onclick=createAppointment(" + items.session_id + ")>Book Appointment</button>"
        })
      },
      error: function (error) {
        console.log(error)
      }
    })
  }





  function createAppointment(s_id) {
    $.ajax({
      type: 'GET',
      url: `/appointment/create_appointment/${s_id}`,
      data: {
        'action': 'book'
      },
      success: function (response) {
        console.log(response)

      },
      error: function (error) {
        console.log(error)
      }
    })
  }

</script>



{% endblock %}